<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch Khen Th∆∞·ªüng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
            background-color: #f5f5f5;
            font-size: 14px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .print-area {
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .header h2 {
            margin: 10px 0;
            font-size: 16px;
            font-weight: normal;
        }
        
        .filter-info {
            background: #e3f2fd;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
        }
        
        .filter-info h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 12px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        
        .data-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-info {
            background: #17a2b8;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .data-info {
            background: #e9ecef;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .summary {
            background: #fff3cd;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            text-align: center;
        }
        
        .summary h3 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            page-break-inside: avoid;
        }
        
        .signature-box {
            text-align: center;
            width: 200px;
        }
        
        .signature-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .signature-date {
            margin-bottom: 80px;
        }
        
        .signature-name {
            font-weight: bold;
            border-top: 1px solid #333;
            padding-top: 5px;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
                font-size: 12px;
            }
            
            .container {
                box-shadow: none;
                max-width: none;
            }
            
            .controls, .data-info {
                display: none !important;
            }
            
            .print-area {
                padding: 15px;
            }
            
            .data-table {
                font-size: 11px;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px;
            }
        }
        
        .col-stt { width: 5%; }
        .col-so-qd { width: 12%; }
        .col-ngay-qd { width: 10%; }
        .col-linh-vuc { width: 12%; }
        .col-nguoi-duoc-khen { width: 20%; }
        .col-thanh-tich { width: 25%; }
        .col-hinh-thuc { width: 12%; }
        .col-nam { width: 4%; }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <button class="btn" onclick="printList()">üñ®Ô∏è In Danh S√°ch</button>
            <button class="btn btn-success" onclick="exportToPDF()">üìÑ Xu·∫•t PDF</button>
            <button class="btn btn-info" onclick="loadSampleData()">üìù T·∫£i D·ªØ Li·ªáu M·∫´u</button>
            <button class="btn" onclick="clearData()">üóëÔ∏è X√≥a D·ªØ Li·ªáu</button>
        </div>
        
        <div class="data-info">
            <strong>Th√¥ng tin ƒëi·ªÅu ki·ªán l·ªçc:</strong>
            <div id="filterInfo">Ch∆∞a c√≥ ƒëi·ªÅu ki·ªán l·ªçc</div>
        </div>
        
        <div class="print-area" id="printArea">
            <div class="header">
                <h1>DANH S√ÅCH KHEN TH∆Ø·ªûNG</h1>
                <h2 id="periodInfo">Th·ªùi gian: ...</h2>
            </div>
            
            <div class="filter-info" id="filterDisplay">
                <h3>ƒêi·ªÅu ki·ªán l·ªçc:</h3>
                <div id="filterDetails">Kh√¥ng c√≥ ƒëi·ªÅu ki·ªán l·ªçc</div>
            </div>
            
            <div class="summary" id="summarySection">
                <h3>T·ªîNG H·ª¢P</h3>
                <div id="summaryDetails">T·ªïng s·ªë b·∫£n ghi: <span id="totalRecords">0</span></div>
            </div>
            
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th class="col-stt">STT</th>
                        <th class="col-so-qd">S·ªë Quy·∫øt ƒë·ªãnh</th>
                        <th class="col-ngay-qd">Ng√†y Qƒê</th>
                        <th class="col-linh-vuc">Lƒ©nh v·ª±c</th>
                        <th class="col-nguoi-duoc-khen">Ng∆∞·ªùi ƒë∆∞·ª£c khen</th>
                        <th class="col-thanh-tich">Th√†nh t√≠ch</th>
                        <th class="col-hinh-thuc">H√¨nh th·ª©c</th>
                        <th class="col-nam">NƒÉm</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="8" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                    </tr>
                </tbody>
            </table>
            
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-title">NG∆Ø·ªúI L·∫¨P</div>
                    <div class="signature-date">Ng√†y ... th√°ng ... nƒÉm ...</div>
                    <div class="signature-name">(...........................)</div>
                </div>
                <div class="signature-box">
                    <div class="signature-title">L√ÉNH ƒê·∫†O DUY·ªÜT</div>
                    <div class="signature-date">Ng√†y ... th√°ng ... nƒÉm ...</div>
                    <div class="signature-name">(...........................)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let khenThuongData = [];
        
        // H√†m l·∫•y tham s·ªë t·ª´ URL
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // H√†m parse d·ªØ li·ªáu JSON t·ª´ URL
        function parseDataFromURL() {
            const dataParam = getURLParameter('data');
            const tu_nam = getURLParameter('tu_nam');
            const den_nam = getURLParameter('den_nam');
            const use_api = getURLParameter('use_api');
            const appsheet_app_id = getURLParameter('appsheet_app_id');
            
            // C·∫≠p nh·∫≠t th√¥ng tin ƒëi·ªÅu ki·ªán l·ªçc
            updateFilterInfo(tu_nam, den_nam);
            
            // N·∫øu s·ª≠ d·ª•ng AppSheet API
            if (use_api === 'true' && appsheet_app_id && tu_nam && den_nam) {
                loadDataFromAppSheetAPI(appsheet_app_id, tu_nam, den_nam);
                return;
            }
            
            if (dataParam) {
                try {
                    const rawData = JSON.parse(decodeURIComponent(dataParam));
                    khenThuongData = Array.isArray(rawData) ? rawData : [rawData];
                    
                    // L·ªçc d·ªØ li·ªáu theo ƒëi·ªÅu ki·ªán nƒÉm
                    if (tu_nam && den_nam) {
                        const tu_nam_int = parseInt(tu_nam);
                        const den_nam_int = parseInt(den_nam);
                        
                        khenThuongData = khenThuongData.filter(item => {
                            const nam = parseInt(item.nam);
                            return nam >= tu_nam_int && nam <= den_nam_int;
                        });
                    }
                    
                    renderTable();
                    updateSummary();
                } catch (error) {
                    console.error('L·ªói parse d·ªØ li·ªáu:', error);
                    document.getElementById('filterInfo').innerHTML = 'L·ªói parse d·ªØ li·ªáu JSON: ' + error.message;
                }
            } else {
                // Th·ª≠ parse t·ª´ c√°c tham s·ªë ri√™ng l·∫ª
                parseIndividualParams(tu_nam, den_nam);
            }
        }
        
        // H√†m m√¥ ph·ªèng g·ªçi AppSheet API
        function loadDataFromAppSheetAPI(appId, tu_nam, den_nam) {
            document.getElementById('filterInfo').innerHTML = 
                `ƒêang t·∫£i d·ªØ li·ªáu t·ª´ AppSheet API v·ªõi ƒëi·ªÅu ki·ªán: nƒÉm ${tu_nam} - ${den_nam}...`;
            
            // M√¥ ph·ªèng API call (th·ª±c t·∫ø s·∫Ω c·∫ßn AppSheet API key v√† endpoint)
            setTimeout(() => {
                // D·ªØ li·ªáu m·∫´u m√¥ ph·ªèng t·ª´ API
                const mockApiData = [
                    {
                        id: '1',
                        so_quyet_dinh: '001/2024/Qƒê-UBND',
                        ngay_quyet_dinh: '15/01/2024',
                        linh_vuc: 'Gi√°o d·ª•c',
                        nguoi_duoc_khen_thuong: 'Nguy·ªÖn VƒÉn A',
                        thanh_tich: 'Xu·∫•t s·∫Øc trong gi·∫£ng d·∫°y',
                        hinh_thuc_khen_thuong: 'B·∫±ng khen',
                        nam: '2024'
                    },
                    {
                        id: '2',
                        so_quyet_dinh: '002/2024/Qƒê-UBND',
                        ngay_quyet_dinh: '20/02/2024',
                        linh_vuc: 'Y t·∫ø',
                        nguoi_duoc_khen_thuong: 'Tr·∫ßn Th·ªã B',
                        thanh_tich: 'T·∫≠n t√¢m chƒÉm s√≥c b·ªánh nh√¢n',
                        hinh_thuc_khen_thuong: 'Gi·∫•y khen',
                        nam: '2024'
                    }
                ];
                
                // L·ªçc theo ƒëi·ªÅu ki·ªán nƒÉm
                const tu_nam_int = parseInt(tu_nam);
                const den_nam_int = parseInt(den_nam);
                
                khenThuongData = mockApiData.filter(item => {
                    const nam = parseInt(item.nam);
                    return nam >= tu_nam_int && nam <= den_nam_int;
                });
                
                renderTable();
                updateSummary();
                
                document.getElementById('filterInfo').innerHTML = 
                    `ƒê√£ t·∫£i ${khenThuongData.length} b·∫£n ghi t·ª´ AppSheet API v·ªõi ƒëi·ªÅu ki·ªán: nƒÉm ${tu_nam} - ${den_nam}`;
            }, 1000);
        }
        
        // H√†m parse t·ª´ c√°c tham s·ªë ri√™ng l·∫ª ho·∫∑c t·ª´ AppSheet
        function parseIndividualParams(tu_nam, den_nam) {
            // Ki·ªÉm tra n·∫øu ch·ªâ c√≥ ƒëi·ªÅu ki·ªán l·ªçc t·ª´ AppSheet
            const action = getURLParameter('action');
            if (action === 'load_filtered_data' && tu_nam && den_nam) {
                // Hi·ªÉn th·ªã th√¥ng b√°o ch·ªù t·∫£i d·ªØ li·ªáu
                document.getElementById('filterInfo').innerHTML = 
                    `S·∫µn s√†ng t·∫£i d·ªØ li·ªáu v·ªõi ƒëi·ªÅu ki·ªán l·ªçc: nƒÉm ${tu_nam} - ${den_nam}. Vui l√≤ng s·ª≠ d·ª•ng n√∫t "T·∫£i D·ªØ Li·ªáu M·∫´u" ho·∫∑c truy·ªÅn d·ªØ li·ªáu qua tham s·ªë.`;
                return;
            }
            
            const singleRecord = {};
            const params = [
                'id', 'linh_vuc', 'so_quyet_dinh', 'ngay_quyet_dinh', 
                'nguoi_ky_quyet_dinh', 'cap_khen_thuong', 'thanh_tich',
                'loai_doi_tuong', 'nguoi_duoc_khen_thuong', 'hinh_thuc_khen_thuong',
                'nam', 'thang', 'ngay_tao', 'nguoi_tao', 'ngay_chinh_sua', 
                'nguoi_chinh_sua'
            ];
            
            let hasData = false;
            params.forEach(param => {
                const value = getURLParameter(param);
                if (value) {
                    singleRecord[param] = decodeURIComponent(value);
                    hasData = true;
                }
            });
            
            if (hasData) {
                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán l·ªçc nƒÉm
                if (tu_nam && den_nam && singleRecord.nam) {
                    const nam = parseInt(singleRecord.nam);
                    const tu_nam_int = parseInt(tu_nam);
                    const den_nam_int = parseInt(den_nam);
                    
                    if (nam >= tu_nam_int && nam <= den_nam_int) {
                        khenThuongData = [singleRecord];
                        renderTable();
                        updateSummary();
                    } else {
                        document.getElementById('filterInfo').innerHTML = 
                            `D·ªØ li·ªáu kh√¥ng th·ªèa m√£n ƒëi·ªÅu ki·ªán l·ªçc: nƒÉm ${nam} kh√¥ng n·∫±m trong kho·∫£ng ${tu_nam} - ${den_nam}`;
                    }
                } else {
                    khenThuongData = [singleRecord];
                    renderTable();
                    updateSummary();
                }
            }
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin ƒëi·ªÅu ki·ªán l·ªçc
        function updateFilterInfo(tu_nam, den_nam) {
            const filterInfo = document.getElementById('filterInfo');
            const filterDisplay = document.getElementById('filterDisplay');
            const periodInfo = document.getElementById('periodInfo');
            
            if (tu_nam && den_nam) {
                const filterText = `L·ªçc theo nƒÉm: ${tu_nam} ‚â§ nƒÉm ‚â§ ${den_nam}`;
                filterInfo.innerHTML = filterText;
                document.getElementById('filterDetails').innerHTML = filterText;
                periodInfo.textContent = `Th·ªùi gian: T·ª´ nƒÉm ${tu_nam} ƒë·∫øn nƒÉm ${den_nam}`;
            } else {
                filterInfo.innerHTML = 'Kh√¥ng c√≥ ƒëi·ªÅu ki·ªán l·ªçc nƒÉm';
                document.getElementById('filterDetails').innerHTML = 'Kh√¥ng c√≥ ƒëi·ªÅu ki·ªán l·ªçc';
                periodInfo.textContent = 'Th·ªùi gian: T·∫•t c·∫£ c√°c nƒÉm';
            }
        }
        
        // Render b·∫£ng d·ªØ li·ªáu
        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            
            if (khenThuongData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu th·ªèa m√£n ƒëi·ªÅu ki·ªán l·ªçc</td></tr>';
                return;
            }
            
            let html = '';
            khenThuongData.forEach((item, index) => {
                html += `
                    <tr>
                        <td class="col-stt">${index + 1}</td>
                        <td class="col-so-qd">${item.so_quyet_dinh || ''}</td>
                        <td class="col-ngay-qd">${item.ngay_quyet_dinh || ''}</td>
                        <td class="col-linh-vuc">${item.linh_vuc || ''}</td>
                        <td class="col-nguoi-duoc-khen">${item.nguoi_duoc_khen_thuong || ''}</td>
                        <td class="col-thanh-tich">${item.thanh_tich || ''}</td>
                        <td class="col-hinh-thuc">${item.hinh_thuc_khen_thuong || ''}</td>
                        <td class="col-nam">${item.nam || ''}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // C·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng h·ª£p
        function updateSummary() {
            document.getElementById('totalRecords').textContent = khenThuongData.length;
            
            // Th·ªëng k√™ theo h√¨nh th·ª©c khen th∆∞·ªüng
            const hinhThucStats = {};
            khenThuongData.forEach(item => {
                const hinhThuc = item.hinh_thuc_khen_thuong || 'Kh√¥ng x√°c ƒë·ªãnh';
                hinhThucStats[hinhThuc] = (hinhThucStats[hinhThuc] || 0) + 1;
            });
            
            let summaryHtml = `T·ªïng s·ªë b·∫£n ghi: <strong>${khenThuongData.length}</strong>`;
            if (Object.keys(hinhThucStats).length > 0) {
                summaryHtml += '<br>Ph√¢n lo·∫°i: ';
                const statsArray = [];
                Object.keys(hinhThucStats).forEach(key => {
                    statsArray.push(`${key}: ${hinhThucStats[key]}`);
                });
                summaryHtml += statsArray.join(' | ');
            }
            
            document.getElementById('summaryDetails').innerHTML = summaryHtml;
        }
        
        // T·∫£i d·ªØ li·ªáu m·∫´u
        function loadSampleData() {
            khenThuongData = [
                {
                    id: '1',
                    so_quyet_dinh: '001/2024/Qƒê-UBND',
                    ngay_quyet_dinh: '15/01/2024',
                    linh_vuc: 'Gi√°o d·ª•c',
                    nguoi_duoc_khen_thuong: 'Nguy·ªÖn VƒÉn A',
                    thanh_tich: 'Xu·∫•t s·∫Øc trong gi·∫£ng d·∫°y',
                    hinh_thuc_khen_thuong: 'B·∫±ng khen',
                    nam: '2024'
                },
                {
                    id: '2',
                    so_quyet_dinh: '002/2024/Qƒê-UBND',
                    ngay_quyet_dinh: '20/02/2024',
                    linh_vuc: 'Y t·∫ø',
                    nguoi_duoc_khen_thuong: 'Tr·∫ßn Th·ªã B',
                    thanh_tich: 'T·∫≠n t√¢m chƒÉm s√≥c b·ªánh nh√¢n',
                    hinh_thuc_khen_thuong: 'Gi·∫•y khen',
                    nam: '2024'
                },
                {
                    id: '3',
                    so_quyet_dinh: '003/2023/Qƒê-UBND',
                    ngay_quyet_dinh: '10/12/2023',
                    linh_vuc: 'N√¥ng nghi·ªáp',
                    nguoi_duoc_khen_thuong: 'L√™ VƒÉn C',
                    thanh_tich: '·ª®ng d·ª•ng c√¥ng ngh·ªá cao',
                    hinh_thuc_khen_thuong: 'B·∫±ng khen',
                    nam: '2023'
                }
            ];
            
            // Gi·∫£ l·∫≠p ƒëi·ªÅu ki·ªán l·ªçc
            updateFilterInfo('2023', '2024');
            
            renderTable();
            updateSummary();
            
            document.getElementById('filterInfo').innerHTML = 'ƒê√£ t·∫£i d·ªØ li·ªáu m·∫´u v·ªõi 3 b·∫£n ghi (2023-2024)';
        }
        
        // X√≥a d·ªØ li·ªáu
        function clearData() {
            khenThuongData = [];
            renderTable();
            updateSummary();
            document.getElementById('filterInfo').innerHTML = 'ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu';
        }
        
        // H√†m in
        function printList() {
            window.print();
        }
        
        // H√†m xu·∫•t PDF
        function exportToPDF() {
            const element = document.getElementById('printArea');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                width: element.scrollWidth,
                height: element.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF.jsPDF('l', 'mm', 'a4'); // Landscape orientation
                const imgWidth = 297; // A4 landscape width
                const pageHeight = 210; // A4 landscape height
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const currentDate = new Date().toISOString().slice(0, 10);
                pdf.save(`danh-sach-khen-thuong-${currentDate}.pdf`);
            });
        }
        
        // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
        window.onload = function() {
            parseDataFromURL();
        };
    </script>
</body>
</html>
